name: Create VPS

on:
  workflow_dispatch:
  repository_dispatch:
    types: [create-vps]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 355

    env:
      DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1354349049410490418/XaRlJspNCk8h8QMkY329QVqNOP2BiJ-hx_1MA00EDSNDXFDJxwPAbjReNuKeGfweTA7X"

    steps:
      - name: ‚¨áÔ∏è Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìÇ Prepare workspace
        run: |
          mkdir -p links .backup temp
          chmod 777 links .backup temp

      - name: üß∞ Install helper tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip jq curl git || true
          if ! command -v tmate >/dev/null 2>&1; then
            sudo apt-get install -y tmate || true
          fi
          if ! command -v docker >/dev/null 2>&1; then
            curl -fsSL https://get.docker.com | sh
          fi
          docker --version || true

      - name: Set Laravel APP_KEY
        run: |
          APP_KEY="base64:0nYbJe1iR9o0bLJYy7exKgDq+Zoy7Z9Wm8rKpW63g2k="
          echo "APP_KEY=$APP_KEY" >> .env

      - name: üï∏ Create docker network
        run: |
          docker network create pteronet || true

      - name: üõ¢ Start MySQL in Docker
        run: |
          docker rm -f pterodactyl_mysql || true
          docker run -d --name pterodactyl_mysql \
            --network pteronet \
            -e MYSQL_ROOT_PASSWORD=rootpass \
            -e MYSQL_DATABASE=pterodactyl_db \
            -e MYSQL_USER=ptero \
            -e MYSQL_PASSWORD=pteropass \
            mysql:8.0 --default-authentication-plugin=mysql_native_password
          echo "Waiting for MySQL..."
          for i in $(seq 1 30); do
            docker exec pterodactyl_mysql mysql -uroot -prootpass -e "SELECT 1;" >/dev/null 2>&1 && break
            sleep 2
          done
          docker exec pterodactyl_mysql mysql -uroot -prootpass -e "SHOW DATABASES;" || (docker logs pterodactyl_mysql && exit 1)

      - name: üîß Start Pterodactyl Panel container
        run: |
          docker rm -f pterodactyl || true
          docker volume create pterodactyl_panel_data || true
          docker run -d --name pterodactyl \
            --network pteronet \
            -p 8080:80 \
            -e DB_HOST=pterodactyl_mysql \
            -e DB_PORT=3306 \
            -e DB_DATABASE=pterodactyl_db \
            -e DB_USERNAME=ptero \
            -e DB_PASSWORD=pteropass \
            -e APP_KEY="base64:0nYbJe1iR9o0bLJYy7exKgDq+Zoy7Z9Wm8rKpW63g2k=" \
            -v pterodactyl_panel_data:/var/www/pterodactyl \
            ghcr.io/pterodactyl/panel:latest
          for i in $(seq 1 30); do
            docker exec pterodactyl php -v >/dev/null 2>&1 && break
            sleep 3
          done

      - name: ‚öôÔ∏è Run migrations
        run: |
          for i in $(seq 1 20); do
            docker exec pterodactyl php artisan migrate --force && break || {
              echo "Retry artisan migrate ($i/20)"
              sleep 10
            }
          done

      - name: üëë Ensure admin user exists
        run: |
          ADMIN_EMAIL="admin@example.com"
          ADMIN_PASS="AdminPass123"
          docker exec -i pterodactyl php artisan p:user:make \
            --email="$ADMIN_EMAIL" \
            --username="admin" \
            --name-first="Auto" \
            --name-last="Admin" \
            --password="$ADMIN_PASS" \
            --admin=1 || true
          echo "EMAIL:$ADMIN_EMAIL" > links/admin_info.txt
          echo "PASS:$ADMIN_PASS" >> links/admin_info.txt

      - name: üêâ Write Wings config & Start Wings container
        run: |
          mkdir -p temp

          # create wings.yml safely
          printf 'panel:\n  url: "http://pterodactyl"\n  token_id: "localtoken"\n  token: "localtoken123"\n  verify_tls: false\napi:\n  host: 0.0.0.0\n  port: 8080\ndocker:\n  network:\n    interface: docker0\n' > temp/wings.yml

          # start Wings container
          docker rm -f pterodactyl_wings || true
          docker run -d --name pterodactyl_wings \
            --privileged \
            --network pteronet \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v /etc/pterodactyl:/etc/pterodactyl:rw \
            -v /var/lib/pterodactyl:/var/lib/pterodactyl:rw \
            -v $PWD/temp/wings.yml:/etc/pterodactyl/config.yml \
            ghcr.io/pterodactyl/wings:latest || true
          sleep 8
          docker logs pterodactyl_wings --tail 50 || true
          docker ps -a -q | xargs -r docker start || true

      - name: üåê Install & start ngrok
        run: |
          cd $GITHUB_WORKSPACE/temp
          curl -s -L "https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip" -o ngrok.zip
          unzip -o ngrok.zip >/dev/null 2>&1 || true
          chmod +x ngrok
          nohup ./ngrok http 8080 >/dev/null 2>&1 &
          sleep 6
          PANEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url' || echo "")
          if [ -z "$PANEL_URL" ] || [ "$PANEL_URL" = "null" ]; then
            PANEL_URL="http://$(curl -s ifconfig.me | tr -d '\n'):8080"
          fi
          echo "$PANEL_URL" | tee links/panel_url.txt

      - name: üîå Start tmate session & capture SSH
        run: |
          if ! command -v tmate >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y tmate
          fi
          VPS_NAME="${GITHUB_EVENT_CLIENT_PAYLOAD_VPS_NAME:-autovps}"
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          echo "$SSH" | tee "links/${VPS_NAME}.txt"
          echo "SSH:$SSH" >> links/admin_info.txt || true

      - name: üíæ Dump MySQL DB
        run: |
          mkdir -p .backup
          docker exec pterodactyl_mysql sh -c 'exec mysqldump -uptero -ppteropass pterodactyl_db' > .backup/pterodactyl.sql || true
          cp temp/wings.yml .backup/wings.yml || true

      - name: üíæ Save panel files
        run: |
          rm -f .backup/panel_files.tar.gz || true
          docker exec pterodactyl sh -c "tar -czf /tmp/panel_files.tar.gz /var/www/pterodactyl 2>/dev/null || true" || true
          docker cp pterodactyl:/tmp/panel_files.tar.gz .backup/panel_files.tar.gz 2>/dev/null || true

      - name: üíº Pack all backups
        run: |
          VPS_NAME="${GITHUB_EVENT_CLIENT_PAYLOAD_VPS_NAME:-autovps}"
          zip -r ".backup/${VPS_NAME}.zip" .backup/* links/* 2>/dev/null || true

      - name: üõ† Prepare Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin main || true
          git checkout main || true
          git pull --rebase origin main || true

      - name: ‚¨ÜÔ∏è Commit & Push backups
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üîÑ Updated SSH, Panel URL, admin info, and backups for ${GITHUB_EVENT_CLIENT_PAYLOAD_VPS_NAME:-autovps}"
          file_pattern: 'links/*.txt .backup/*.zip .backup/*.sql .backup/*.yml'
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          push_options: '--force-with-lease'
